<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #output, #serialOutput {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            min-height: 50px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px;
        }
        label {
            display: inline-block;
            margin: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>WASM Demo</h1>

    <!-- Hello Demo Section -->
    <div class="section">
        <h2>Hello Demo</h2>
        <p>Click the button to call the WASM say_hello() function:</p>
        <button id="helloButton">Say Hello</button>
        <div id="output">
            <p><em>Check the browser console for output</em></p>
        </div>
    </div>

    <!-- Serial Port Demo Section -->
    <div class="section">
        <h2>Web Serial API Demo</h2>
        <p>This demonstrates Web Serial API access from WASM code.</p>

        <div>
            <button id="requestPortBtn">Request Serial Port</button>
            <button id="openPortBtn" disabled>Open Port</button>
            <button id="closePortBtn" disabled>Close Port</button>
        </div>

        <div>
            <label>Baud Rate:</label>
            <input type="number" id="baudRate" value="115200" />
        </div>

        <div>
            <label>Send Data:</label>
            <input type="text" id="sendData" placeholder="Enter text to send" />
            <button id="sendBtn" disabled>Send</button>
        </div>

        <div>
            <button id="readBtn" disabled>Read Data</button>
            <button id="clearOutputBtn">Clear Output</button>
        </div>

        <div>
            <button id="testHactarBtn" disabled>Test for Hactar Device</button>
        </div>

        <div id="serialOutput">
Status: Not connected
        </div>
    </div>

    <script type="module">
        import init, {
            say_hello,
            serial_request_port,
            serial_open_port,
            serial_close_port,
            serial_read_bytes,
            serial_write_string,
            test_for_hactar
        } from './pkg/wasm_demo.js';

        let currentPort = null;
        let isOpen = false;

        function log(message) {
            const output = document.getElementById('serialOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function updateButtons() {
            const hasPort = currentPort !== null;
            document.getElementById('openPortBtn').disabled = !hasPort || isOpen;
            document.getElementById('closePortBtn').disabled = !isOpen;
            document.getElementById('sendBtn').disabled = !isOpen;
            document.getElementById('readBtn').disabled = !isOpen;
            document.getElementById('testHactarBtn').disabled = !isOpen;
        }

        async function run() {
            await init();

            // Hello button
            document.getElementById('helloButton').addEventListener('click', () => {
                say_hello();
            });

            // Request port button
            document.getElementById('requestPortBtn').addEventListener('click', async () => {
                try {
                    log('Requesting serial port...');
                    currentPort = await serial_request_port();
                    log('Port granted');
                    updateButtons();
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Open port button
            document.getElementById('openPortBtn').addEventListener('click', async () => {
                try {
                    const baudRate = parseInt(document.getElementById('baudRate').value);
                    log(`Opening port at ${baudRate} baud...`);
                    await serial_open_port(currentPort, baudRate);
                    log('Port opened successfully');
                    isOpen = true;
                    updateButtons();
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Close port button
            document.getElementById('closePortBtn').addEventListener('click', async () => {
                try {
                    log('Closing port...');
                    await serial_close_port(currentPort);
                    log('Port closed');
                    isOpen = false;
                    updateButtons();
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Send button
            document.getElementById('sendBtn').addEventListener('click', async () => {
                try {
                    const data = document.getElementById('sendData').value;
                    if (data) {
                        log(`Sending: ${data}`);
                        await serial_write_string(currentPort, data);
                        log('Data sent');
                        document.getElementById('sendData').value = '';
                    }
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Read button
            document.getElementById('readBtn').addEventListener('click', async () => {
                try {
                    log('Reading data...');
                    const data = await serial_read_bytes(currentPort);
                    if (data.length === 0) {
                        log('No data available (EOF)');
                    } else {
                        // Convert byte array to string
                        const text = new TextDecoder().decode(new Uint8Array(data));
                        log(`Received (${data.length} bytes): ${text}`);
                    }
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Test for Hactar button
            document.getElementById('testHactarBtn').addEventListener('click', async () => {
                try {
                    log('Testing for Hactar device...');
                    log('Sending: who are you');
                    const isHactar = await test_for_hactar(currentPort);
                    if (isHactar) {
                        log('✓ SUCCESS: Device is a Hactar device!');
                    } else {
                        log('✗ FAILED: Device is not a Hactar device or response mismatch');
                    }
                } catch (error) {
                    log(`Error: ${error}`);
                }
            });

            // Clear output button
            document.getElementById('clearOutputBtn').addEventListener('click', () => {
                document.getElementById('serialOutput').textContent = 'Status: Ready\n';
            });

            updateButtons();
        }

        run();
    </script>
</body>
</html>
